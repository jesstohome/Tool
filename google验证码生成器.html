<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>纯 JS TOTP</title>
<style>
  body { font-family: sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; background:#f0f0f0; }
  .container { background:#fff; padding:40px; border-radius:16px; text-align:center; box-shadow:0 8px 20px rgba(0,0,0,0.15); }
  #code { font-size:64px; letter-spacing:8px; margin-bottom:20px; }
  #timer { color:#888; }
</style>
</head>
<body>

<div class="container">
  <div id="code">------</div>
  <div id="timer">刷新倒计时：30 秒</div>
</div>

<script>
// ====== 你的 Base32 密钥 ======
const secret = 'JBSWY3DPEHPK3PXP';

// Base32 → Uint8Array
function base32toUint8Array(base32) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    const padding = '=';

    base32 = base32.replace(new RegExp('=', 'g'), '');
    const bytes = [];
    let bits = 0, value = 0;

    for (let i = 0; i < base32.length; i++) {
        const idx = alphabet.indexOf(base32[i].toUpperCase());
        if (idx === -1) continue;
        value = (value << 5) | idx;
        bits += 5;
        if (bits >= 8) {
            bytes.push((value >>> (bits - 8)) & 0xFF);
            bits -= 8;
        }
    }
    return new Uint8Array(bytes);
}

// TOTP 生成函数
async function generateTOTP(secret) {
    const key = base32toUint8Array(secret);
    const epoch = Math.floor(Date.now() / 1000);
    const timeSlice = Math.floor(epoch / 30);

    const timeBuffer = new ArrayBuffer(8);
    const timeArray = new DataView(timeBuffer);
    timeArray.setUint32(4, timeSlice); // 高 4 字节 0
    // HMAC-SHA1
    const cryptoKey = await crypto.subtle.importKey(
        'raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']
    );
    const hmac = await crypto.subtle.sign('HMAC', cryptoKey, timeBuffer);
    const hmacBytes = new Uint8Array(hmac);
    const offset = hmacBytes[hmacBytes.length - 1] & 0xf;
    const code = ((hmacBytes[offset] & 0x7f) << 24 |
                  (hmacBytes[offset + 1] & 0xff) << 16 |
                  (hmacBytes[offset + 2] & 0xff) << 8 |
                  (hmacBytes[offset + 3] & 0xff)) % 1000000;
    return code.toString().padStart(6, '0');
}

// 更新显示
async function updateCode() {
    const code = await generateTOTP(secret);
    document.getElementById('code').textContent = code;
    const epoch = Math.floor(Date.now() / 1000);
    const remaining = 30 - (epoch % 30);
    document.getElementById('timer').textContent = `刷新倒计时：${remaining} 秒`;
}

updateCode();
setInterval(updateCode, 1000);

</script>

</body>
</html>
